# database-engine
 
 c++实现简单关系型数据库

数据是存储在物理磁盘上的，而真正的数据处理又是在内存中执行的。由于磁盘的读写速度非常慢，如果每次操作都对磁盘进行频繁读写的话，那么性能一定非常差。为了上述问题，InnoDB将数据划分为若干页，以页作为磁盘与内存交互的基本单位，

一个页通常由：页头（metadata） + 数据区（record） + 槽目录/slot array（索引记录位置） + 空闲区（free space） + 可选的页尾/校验（checksum）组成。内部页和叶子页在“数据区”内容上不同（children vs values）。

在页面内部，有两种组织数据的方式，基于元组的和基于日志结构的。
最常见的页面内部布局方式是slotted pages。这种方式是基于元组的，它将页面分为了三部分，第一部分是头部，保存一些元数据，第二部分是slot array，第三部分是数据部分。slot array从头部开始，向后增长，每个slot保存一个指针，指向对应元组在数据部分的开始位置。数据部分从页面尾部向前增长。头部记录哪些slots已经被使用，以及最后一个slot的开始位置。


 未完成内容：
 二进制格式：把txt存储改为二进制文件存储
 WAL: 用于保证写入的原子性和崩溃恢复。写操作先追加到日志（顺序写），并在合适时刻将日志内容应用到数据页（checkpoint）。
 映射：把文件 memory-map（映射到虚拟内存）
 数据序列化格式：文档数据库常用 BSON（二进制 JSON）等格式做记录序列化（MongoDB）；关系型通常把列/行编码为紧凑二进制格式或列式存储格式。
 压缩、校验和：生产系统常支持压缩（Snappy、zlib）与校验（CRC）以节省空间并检测损坏。


持久化：页式存储、缓冲池、WAL
删除操作：完整删除算法
性能：所有查找改为二分查找
P1（重要）：
并发控制：读写锁、MVCC
错误处理：异常处理、边界检查
P2（优化）：
变长键支持
批量操作优化
统计信息收集

某些平台访问未对齐数据慢或出错：
磁盘上用紧凑（packed）二进制布局，但程序读磁盘数据时不要直接按成员访问 packed 结构；应把字节拷贝到本地对齐的变量或显式逐字节解析（序列化/反序列化）。这样既兼顾磁盘紧凑，又能避免未对齐的访问



首先需要清楚 页(Page) 和 盘区(Extent) 的概念。页是SQL Server中数据存储的基本单元，每一页的大小都是4K。而盘区是一组页的集合，每一个盘区都是由8个相邻的页组合而成的。

slotted page是数据库中页的常见组织形式。优点是可以存储可变长的tuple。其核心是通过slot 数组中存储的偏移值来查找page中的某个tuple具体内容是什么。即可以通过page号和slot 号就可以查询磁盘上任意一个tuple的内容